<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clicker123</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ®</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #007bff;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-size: 18px;
        }

        .content {
            flex: 1;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            background: var(--tg-theme-bg-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-top: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-top: 2px solid var(--tg-theme-button-color);
            background: #f5f5f5;
        }

        .image-button {
            width: 200px;
            height: 200px;
            border: none;
            background-image: url('https://gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-znachok-bitkoina-na-prozrachnom-fone-15.png');
            background-size: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-button:active {
            transform: scale(0.95);
        }

        .button {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .energy-fill {
            height: 100%;
            background: var(--tg-theme-button-color);
            transition: width 0.3s;
        }

        #balance, #energy {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .boost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="content" id="content1">
        <h1 id="balance">0</h1>
        <div id="energy">Energy: 100/100</div>
        <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="width: 100%"></div></div>
        <button id="click" class="image-button"></button>
    </div>
    <div class="content" id="content2" style="display:none;">
        <h2>Boosts</h2>
        <div id="boosts">
            <div class="boost-item">
                <span>Click Power +1 (Level <span class="level-multiply-per-click">1</span>)</span>
                <button class="button boost-multiply-per-click">Buy (<span class="cost-multiply-per-click">100</span>)</button>
            </div>
            <div class="boost-item">
                <span>Energy Limit +100 (Level <span class="level-energy-limit">1</span>)</span>
                <button class="button boost-energy-limit">Buy (<span class="cost-energy-limit">200</span>)</button>
            </div>
            <div class="boost-item">
                <span>Faster Energy Recharge (Level <span class="level-recharge-energy">1</span>)</span>
                <button class="button boost-recharge-energy">Buy (<span class="cost-recharge-energy">150</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 1 (Level <span class="level-passive-card1">0</span>)</span>
                <button class="button boost-passive-card1">Buy (<span class="cost-passive-card1">300</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 2 (Level <span class="level-passive-card2">0</span>)</span>
                <button class="button boost-passive-card2">Buy (<span class="cost-passive-card2">500</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 3 (Level <span class="level-passive-card3">0</span>)</span>
                <button class="button boost-passive-card3">Buy (<span class="cost-passive-card3">1000</span>)</button>
            </div>
        </div>
    </div>
    <div class="content" id="content3" style="display:none;">
        <h2>Friends</h2>
        <p>Invite friends to earn bonuses!</p>
        <button class="button invite-friend">Invite Friend</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="1">Click</div>
        <div class="tab" data-tab="2">Boost</div>
        <div class="tab" data-tab="3">Friends</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, setPersistence } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

        // Firebase Configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBhLISxR41ZYKyyffiY08c_YtqYQdu85pk",
            authDomain: "test-b5ec3.firebaseapp.com",
            databaseURL: "https://test-b5ec3-default-rtdb.firebaseio.com",
            projectId: "test-b5ec3",
            storageBucket: "test-b5ec3.appspot.com",
            messagingSenderId: "489032935342",
            appId: "1:489032935342:web:922e8c518ad0ff6b6eca3f",
            measurementId: "G-YNQM9CV4P3"
        };

        // Game State
        var gameState = {
            balance: 0,
            serverBalance: 0,
            clickCounter: 0,
            energy: 100,
            maxEnergy: 100,
            rechargeRate: 1,
            clickPower: 1,
            passiveIncome: { card1: 0, card2: 0, card3: 0 },
            lastClickTime: 0,
            lastEnergyUpdate: 0,
            firstClickTime: 0,
            recentClicks: {},
            pendingClicks: 0,
            MIN_CLICK_INTERVAL: 100,
            ENERGY_UPDATE_INTERVAL: 1000,
            MAX_CLICKS_PER_SECOND: 10,
            CLICK_SAVE_THRESHOLD: 50,
            PASSIVE_INCOME_MAX_HOURS: 6,
            boostConfig: {
                multiply_per_click: {
                    cost: function(level) { return Math.floor(100 * level * level); },
                    effect: function(level) { return level; }
                },
                energy_limit: {
                    cost: function(level) { return Math.floor(200 * level * level); },
                    effect: function(level) { return level * 100; }
                },
                recharge_energy: {
                    cost: function(level) { return Math.floor(150 * level * level); },
                    effect: function(level) { return level; }
                },
                passive_income: {
                    card1: {
                        cost: function(level) { return Math.floor(300 * level * level); },
                        income: 1
                    },
                    card2: {
                        cost: function(level) { return Math.floor(500 * level * level); },
                        income: 2
                    },
                    card3: {
                        cost: function(level) { return Math.floor(1000 * level * level); },
                        income: 5
                    }
                }
            }
        };

        // Firebase Initialization
        var app = initializeApp(firebaseConfig);
        var db = getDatabase(app);
        var auth = getAuth(app);

        // App Initialization
        function startApp() {
            var tg = window.Telegram.WebApp;
            tg.expand();

            var userId = tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? tg.initDataUnsafe.user.id : null;
            var urlParams = new URLSearchParams(window.location.search);
            var pass1 = urlParams.get("pass1");

            if (!userId || !pass1) {
                console.error("Missing userId or pass1");
                alert("Error: Unable to get Telegram user ID or password");
                tg.close();
                return;
            }
            console.log("App initialized: userId=" + userId);

            var email = userId + "@example.com";
            setPersistence(auth, "none")
                .then(function() { return signInWithEmailAndPassword(auth, email, pass1); })
                .then(function(userCredential) {
                    console.log("Auth successful for user: " + userId);
                    initializeUserData(userId);
                    logLogin(userId);
                    bindGameEvents(userId);
                    bindUIEvents(userId);
                })
                .catch(function(error) {
                    console.error("Authentication failed: " + error.message);
                    alert("Authentication failed: " + error.message);
                    tg.close();
                });
        }

        // Firebase Functions
        function logLogin(userId) {
            var now = Date.now();
            var loginData = 1;
            if (typeof loginData !== "number" || loginData !== 1) {
                console.error("Invalid login data: " + loginData);
                return;
            }
            set(ref(db, "users/" + userId + "/login_history/" + now), loginData)
                .then(function() { console.log("Login recorded: t=" + now); })
                .catch(function(error) {
                    console.error("Error logging login: " + error.message);
                    alert("Failed to record login: " + error.message);
                });
        }

        function initializeUserData(userId) {
            var userRef = ref(db, "users/" + userId);
            try {
                onValue(userRef, function(snapshot) {
                    if (snapshot.exists()) {
                        var data = snapshot.val();
                        console.log("User data loaded: " + JSON.stringify(data));
                        gameState.serverBalance = data.server_balance || 0;
                        gameState.clickCounter = gameState.serverBalance;
                        gameState.energy = Math.floor(data.energy || 100);
                        gameState.maxEnergy = Math.floor(data.max_energy || 100);
                        gameState.rechargeRate = data.recharge_rate || 1;
                        gameState.clickPower = data.boosts && data.boosts.multiply_per_click ? Math.max(1, Object.keys(data.boosts.multiply_per_click).length) : 1;
                        gameState.passiveIncome.card1 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card1 ? Object.keys(data.boosts.passive_income.card1).length : 0;
                        gameState.passiveIncome.card2 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card2 ? Object.keys(data.boosts.passive_income.card2).length : 0;
                        gameState.passiveIncome.card3 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card3 ? Object.keys(data.boosts.passive_income.card3).length : 0;
                        if (data.click_balance_history && Object.keys(data.click_balance_history).length > 0) {
                            gameState.firstClickTime = parseInt(Object.keys(data.click_balance_history)[0]) || 0;
                        }
                        calculateRealBalance(userId, data).then(function(balance) {
                            gameState.balance = balance;
                            localStorage.setItem("balance_" + userId, gameState.balance);
                            console.log("Firebase init: serverBalance=" + gameState.serverBalance + ", balance=" + gameState.balance);
                            updateUI();
                        });
                    } else {
                        console.log("No user data, initializing new data");
                        set(ref(db, "users/" + userId), {
                            server_balance: 0,
                            energy: 100,
                            max_energy: 100,
                            recharge_rate: 1
                        }).then(function() {
                            gameState.balance = 0;
                            gameState.serverBalance = 0;
                            gameState.clickCounter = 0;
                            gameState.energy = 100;
                            gameState.maxEnergy = 100;
                            gameState.rechargeRate = 1;
                            gameState.clickPower = 1;
                            gameState.passiveIncome = { card1: 0, card2: 0, card3: 0 };
                            localStorage.setItem("balance_" + userId, gameState.balance);
                            console.log("New user initialized: balance=0, serverBalance=0");
                            updateUI();
                        }).catch(function(error) {
                            console.error("Error initializing new user: " + error.message);
                            alert("Failed to initialize user: " + error.message);
                        });
                    }
                }, { onlyOnce: true });
            } catch (error) {
                console.error("Error initializing user data: " + error.message);
                alert("Failed to initialize user data: " + error.message);
            }
        }

        function saveClickHistory(userId, timestamp, clickCounter) {
            if (!timestamp || !Number.isInteger(timestamp) || !Number.isInteger(clickCounter) || clickCounter < 0) {
                console.error("Invalid click history data: t=" + timestamp + ", clickCounter=" + clickCounter);
                return;
            }
            set(ref(db, "users/" + userId + "/click_balance_history/" + timestamp), clickCounter)
                .then(function() {
                    console.log("Click history saved: t=" + timestamp + ", clickCounter=" + clickCounter);
                    gameState.pendingClicks = 0;
                    saveServerBalance(userId);
                })
                .catch(function(error) {
                    console.error("Error saving click history: " + error.message);
                    alert("Failed to save click history: " + error.message);
                });
        }

        function saveServerBalance(userId) {
            if (!Number.isInteger(gameState.serverBalance) || gameState.serverBalance < 0) {
                console.error("Invalid server_balance: " + gameState.serverBalance);
                return;
            }
            set(ref(db, "users/" + userId + "/server_balance"), gameState.serverBalance)
                .then(function() { console.log("Server balance saved: " + gameState.serverBalance); })
                .catch(function(error) {
                    console.error("Error saving server balance: " + error.message);
                    alert("Failed to save server balance: " + error.message);
                });
        }

        function saveEnergy(userId) {
            if (!Number.isInteger(gameState.energy) || gameState.energy < 0) {
                console.error("Invalid energy: " + gameState.energy);
                return;
            }
            set(ref(db, "users/" + userId + "/energy"), gameState.energy)
                .then(function() { console.log("Energy saved: " + gameState.energy); })
                .catch(function(error) {
                    console.error("Error saving energy: " + error.message);
                    alert("Failed to save energy: " + error.message);
                });
        }

        function saveBoost(userId, path, level, timestamp) {
            set(ref(db, "users/" + userId + "/boosts/" + path + "/" + level), timestamp)
                .then(function() { console.log("Boost saved: path=" + path + ", level=" + level + ", timestamp=" + timestamp); })
                .catch(function(error) {
                    console.error("Error saving boost: " + error.message);
                    alert("Failed to save boost: " + error.message);
                });
        }

      function calculateRealBalance(userId, data) {
            return new Promise(function(resolve) {
                try {
                    console.log("Calculating balance for user: " + userId);

                    var clickBalance = 0;
                    if (data.click_balance_history && Object.keys(data.click_balance_history).length > 0) {
                        var lastKey = Object.keys(data.click_balance_history).sort(function(a, b) { return b - a; })[0];
                        clickBalance = data.click_balance_history[lastKey] || 0;
                        console.log("clickBalance=" + clickBalance + ", lastKey=" + lastKey);
                    } else {
                        console.log("No click_balance_history, clickBalance=0");
                    }

                    var passiveIncomeEvents = {};
                    var boostConfig = gameState.boostConfig;
                    if (data.boosts && data.boosts.passive_income) {
                        var cards = ["card1", "card2", "card3"];
                        for (var i = 0; i < cards.length; i++) {
                            var card = cards[i];
                            if (data.boosts.passive_income[card]) {
                                for (var level in data.boosts.passive_income[card]) {
                                    var timestamp = data.boosts.passive_income[card][level];
                                    if (timestamp && Number.isInteger(timestamp)) {
                                        passiveIncomeEvents[card + "_" + level] = {
                                            timestamp: timestamp,
                                            rate: boostConfig.passive_income[card].income
                                        };
                                    }
                                }
                            }
                        }
                        console.log("Passive income events: " + JSON.stringify(passiveIncomeEvents));
                    } else {
                        console.log("No passive_income boosts, passiveIncomeEvents empty");
                    }

                    var totalPassiveIncome = 0;
                    var loginTimestamps = data.login_history && Object.keys(data.login_history).length > 0
                        ? Object.keys(data.login_history)
                              .filter(function(t) { return data.login_history[t] === 1; })
                              .map(Number)
                              .sort(function(a, b) { return a - b; })
                        : [];
                    var now = Date.now();
                    var maxSeconds = gameState.PASSIVE_INCOME_MAX_HOURS * 3600;

                    if (loginTimestamps.length > 0) {
                        for (var i = 0; i < loginTimestamps.length; i++) {
                            var loginTime = loginTimestamps[i];
                            var nextTime = i + 1 < loginTimestamps.length ? loginTimestamps[i + 1] : now;
                            var sessionDuration = Math.min((nextTime - loginTime) / 1000, maxSeconds);

                            var sessionEvents = [];
                            for (var key in passiveIncomeEvents) {
                                var e = passiveIncomeEvents[key];
                                if (loginTime <= e.timestamp && e.timestamp <= nextTime) {
                                    sessionEvents.push(e);
                                }
                            }
                            sessionEvents.push({ timestamp: nextTime, rate: 0 });
                            sessionEvents.sort(function(a, b) { return a.timestamp - b.timestamp; });

                            var currentRate = 0;
                            var lastTime = loginTime;
                            for (var j = 0; j < sessionEvents.length; j++) {
                                var event = sessionEvents[j];
                                var duration = Math.min((event.timestamp - lastTime) / 1000, sessionDuration);
                                if (duration > 0) {
                                    totalPassiveIncome += currentRate * duration;
                                    sessionDuration -= duration;
                                }
                                currentRate += event.rate;
                                lastTime = event.timestamp;
                            }
                        }
                        console.log("totalPassiveIncome=" + totalPassiveIncome);
                    } else {
                        console.log("No login_history, totalPassiveIncome=0");
                    }

                    var totalSpent = 0;
                    if (data.boosts) {
                        var boostTypes = ["multiply_per_click", "energy_limit", "recharge_energy"];
                        for (var i = 0; i < boostTypes.length; i++) {
                            var boostType = boostTypes[i];
                            if (data.boosts[boostType]) {
                                for (var level in data.boosts[boostType]) {
                                    var lvl = parseInt(level);
                                    if (lvl > 0) {
                                        totalSpent += boostConfig[boostType].cost(lvl);
                                    }
                                }
                            }
                        }
                        if (data.boosts.passive_income) {
                            var cards = ["card1", "card2", "card3"];
                            for (var i = 0; i < cards.length; i++) {
                                var card = cards[i];
                                if (data.boosts.passive_income[card]) {
                                    for (var level in data.boosts.passive_income[card]) {
                                        var lvl = parseInt(level);
                                        if (lvl > 0) {
                                            totalSpent += boostConfig.passive_income[card].cost(lvl);
                                        }
                                    }
                                }
                            }
                        }
                        console.log("totalSpent=" + totalSpent);
                    } else {
                        console.log("No boosts, totalSpent=0");
                    }

                    var realBalance = clickBalance + totalPassiveIncome - totalSpent;
                    if (realBalance < 0) {
                        console.warn("Negative balance detected: " + realBalance + ", resetting to 0");
                        resolve(0);
                    } else {
                        console.log("Real balance calculated: clicks=" + clickBalance + ", passive=" + totalPassiveIncome + ", spent=" + totalSpent + ", realBalance=" + realBalance);
                        resolve(realBalance);
                    }
                } catch (error) {
                    console.error("Error calculating real balance: " + error.message);
                    resolve(0);
                }
            });
        }

        // Game Functions
        function bindGameEvents(userId) {
            var clickButton = document.getElementById("click");
            if (clickButton) {
                clickButton.addEventListener("click", function() { handleClick(userId); });
            } else {
                console.error("Click button not found");
            }

            setInterval(function() { regenerateEnergy(userId); }, gameState.ENERGY_UPDATE_INTERVAL);
            setInterval(function() { applyPassiveIncome(userId); }, 1000);
            bindBoostButtons(userId);
        }

        function handleClick(userId) {
            var now = Date.now();
            if (now - gameState.lastClickTime < gameState.MIN_CLICK_INTERVAL) {
                console.log("Click blocked: too frequent");
                return;
            }
            var clickCount = 0;
            for (var t in gameState.recentClicks) {
                if (now - parseInt(t) < 1000) clickCount++;
            }
            if (clickCount >= gameState.MAX_CLICKS_PER_SECOND) {
                console.error("Too many clicks: " + clickCount);
                alert("Too many clicks. Please slow down.");
                return;
            }
            gameState.recentClicks[now] = true;
            gameState.lastClickTime = now;
            if (gameState.energy >= 1) {
                gameState.energy -= 1;
                gameState.clickCounter += gameState.clickPower;
                gameState.serverBalance += gameState.clickPower;
                gameState.pendingClicks += gameState.clickPower;
                gameState.balance += gameState.clickPower;
                localStorage.setItem("balance_" + userId, gameState.balance);
                console.log("Click: clickCounter=" + gameState.clickCounter + ", serverBalance=" + gameState.serverBalance + ", pendingClicks=" + gameState.pendingClicks + ", balance=" + gameState.balance);
                if (gameState.pendingClicks >= gameState.CLICK_SAVE_THRESHOLD) {
                    saveClickHistory(userId, now, gameState.clickCounter);
                }
                saveEnergy(userId);
                updateUI();
            } else {
                console.log("Not enough energy: " + gameState.energy);
                alert("Not enough energy!");
            }
        }

        function regenerateEnergy(userId) {
            var now = Date.now();
            if (now - gameState.lastEnergyUpdate < gameState.ENERGY_UPDATE_INTERVAL) return;
            if (gameState.energy < gameState.maxEnergy) {
                var increase = Math.min(gameState.rechargeRate, gameState.maxEnergy - gameState.energy);
                gameState.energy += increase;
                gameState.lastEnergyUpdate = now;
                console.log("Energy regen: energy=" + gameState.energy + ", increase=" + increase);
                saveEnergy(userId);
                updateUI();
            }
        }

        function applyPassiveIncome(userId) {
            var totalPassive = gameState.passiveIncome.card1 * gameState.boostConfig.passive_income.card1.income +
                              gameState.passiveIncome.card2 * gameState.boostConfig.passive_income.card2.income +
                              gameState.passiveIncome.card3 * gameState.boostConfig.passive_income.card3.income;
            if (totalPassive > 0) {
                gameState.balance += totalPassive;
                localStorage.setItem("balance_" + userId, gameState.balance);
                console.log("Passive income: balance=" + gameState.balance + ", totalPassive=" + totalPassive);
                updateUI();
            }
        }

        function buyBoost(userId, type, path, cost, updateFn) {
            console.log("Buy attempt: type=" + type + ", balance=" + gameState.balance + ", serverBalance=" + gameState.serverBalance + ", cost=" + cost);
            if (gameState.balance >= cost && gameState.serverBalance >= cost) {
                gameState.balance -= cost;
                gameState.serverBalance -= cost;
                localStorage.setItem("balance_" + userId, gameState.balance);
                updateFn();
                var now = Date.now();
                var level = getNextLevel(path);
                saveBoost(userId, path, level, now);
                saveServerBalance(userId);
                updateUI();
                console.log("Boost purchased: type=" + type + ", level=" + level + ", cost=" + cost + ", timestamp=" + now);
            } else {
                console.log("Not enough coins: balance=" + gameState.balance + ", serverBalance=" + gameState.serverBalance + ", cost=" + cost);
                alert("Not enough coins!");
            }
        }

        function getNextLevel(path) {
            if (path === "multiply_per_click") return gameState.clickPower + 1;
            if (path === "energy_limit") return gameState.maxEnergy / 100 + 1;
            if (path === "recharge_energy") return gameState.rechargeRate + 1;
            if (path === "passive_income/card1") return gameState.passiveIncome.card1 + 1;
            if (path === "passive_income/card2") return gameState.passiveIncome.card2 + 1;
            if (path === "passive_income/card3") return gameState.passiveIncome.card3 + 1;
            return 1;
        }

        function bindBoostButtons(userId) {
            var buttons = {
                ".boost-multiply-per-click": { type: "multiply_per_click", path: "multiply_per_click", updateFn: function() { gameState.clickPower += 1; } },
                ".boost-energy-limit": { type: "energy_limit", path: "energy_limit", updateFn: function() { 
                    gameState.maxEnergy += 100; 
                    set(ref(db, "users/" + userId + "/max_energy"), gameState.maxEnergy); 
                } },
                ".boost-recharge-energy": { type: "recharge_energy", path: "recharge_energy", updateFn: function() { 
                    gameState.rechargeRate += 0.5; 
                    set(ref(db, "users/" + userId + "/recharge_rate"), gameState.rechargeRate); 
                } },
                ".boost-passive-card1": { type: "passive_income/card1", path: "passive_income/card1", updateFn: function() { gameState.passiveIncome.card1 += 1; } },
                ".boost-passive-card2": { type: "passive_income/card2", path: "passive_income/card2", updateFn: function() { gameState.passiveIncome.card2 += 1; } },
                ".boost-passive-card3": { type: "passive_income/card3", path: "passive_income/card3", updateFn: function() { gameState.passiveIncome.card3 += 1; } }
            };

            for (var selector in buttons) {
                var button = document.querySelector(selector);
                if (button) {
                    (function(btn, type, path, updateFn) {
                        btn.addEventListener("click", function() {
                            var cost = type.indexOf("passive_income") === 0 
                                ? gameState.boostConfig.passive_income[type.split("/")[1]].cost(getNextLevel(path))
                                : gameState.boostConfig[type].cost(getNextLevel(path));
                            buyBoost(userId, type, path, cost, updateFn);
                        });
                    })(button, buttons[selector].type, buttons[selector].path, buttons[selector].updateFn);
                } else {
                    console.error("Boost button " + selector + " not found");
                }
            }
        }

        // UI Functions
        function updateUI() {
            try {
                var balanceEl = document.getElementById("balance");
                var energyEl = document.getElementById("energy");
                var energyFillEl = document.getElementById("energy-fill");

                if (balanceEl) balanceEl.innerText = Math.floor(gameState.balance);
                else console.error("Element #balance not found");

                if (energyEl) energyEl.innerText = "Energy: " + gameState.energy + "/" + gameState.maxEnergy;
                else console.error("Element #energy not found");

                if (energyFillEl) energyFillEl.style.width = ((gameState.energy / gameState.maxEnergy) * 100) + "%";
                else console.error("Element #energy-fill not found");

                var uiElements = {
                    ".level-multiply-per-click": gameState.clickPower,
                    ".cost-multiply-per-click": gameState.boostConfig.multiply_per_click.cost(gameState.clickPower),
                    ".level-energy-limit": gameState.maxEnergy / 100,
                    ".cost-energy-limit": gameState.boostConfig.energy_limit.cost(gameState.maxEnergy / 100),
                    ".level-recharge-energy": gameState.rechargeRate,
                    ".cost-recharge-energy": gameState.boostConfig.recharge_energy.cost(gameState.rechargeRate),
                    ".level-passive-card1": gameState.passiveIncome.card1,
                    ".cost-passive-card1": gameState.boostConfig.passive_income.card1.cost(gameState.passiveIncome.card1 + 1),
                    ".level-passive-card2": gameState.passiveIncome.card2,
                    ".cost-passive-card2": gameState.boostConfig.passive_income.card2.cost(gameState.passiveIncome.card2 + 1),
                    ".level-passive-card3": gameState.passiveIncome.card3,
                    ".cost-passive-card3": gameState.boostConfig.passive_income.card3.cost(gameState.passiveIncome.card3 + 1)
                };

                for (var selector in uiElements) {
                    var el = document.querySelector(selector);
                    if (el) el.innerText = uiElements[selector];
                    else console.error("Element " + selector + " not found");
                }

                console.log("UI updated: balance=" + gameState.balance + ", energy=" + gameState.energy + "/" + gameState.maxEnergy);
            } catch (error) {
                console.error("Error updating UI: " + error.message);
            }
        }

        function bindUIEvents(userId) {
            var tabs = document.querySelectorAll(".tab");
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener("click", function() {
                    var tabIndex = parseInt(this.getAttribute("data-tab"));
                    var contents = document.querySelectorAll(".content");
                    for (var j = 0; j < contents.length; j++) {
                        contents[j].style.display = j === tabIndex - 1 ? "block" : "none";
                    }
                    var allTabs = document.querySelectorAll(".tab");
                    for (var k = 0; k < allTabs.length; k++) {
                        allTabs[k].classList.toggle("active", k === tabIndex - 1);
                    }
                    console.log("Switched to tab: " + tabIndex);
                    updateUI();
                });
            }

            var inviteButton = document.querySelector(".invite-friend");
            if (inviteButton) {
                inviteButton.addEventListener("click", function() {
                    try {
                        var inviteLink = "https://t.me/your_bot?start=" + encodeURIComponent(userId);
                        var shareUrl = "https://t.me/share/url?url=" + encodeURIComponent(inviteLink) + "&text=" + encodeURIComponent("Join my game!");
                        window.Telegram.WebApp.openTelegramLink(shareUrl);
                        console.log("Invite link generated: " + inviteLink);
                    } catch (error) {
                        console.error("Error generating invite link: " + error.message);
                        alert("Failed to generate invite link. Please try again.");
                    }
                });
            } else {
                console.error("Invite button not found");
            }

            window.Telegram.WebApp.onEvent("mainButtonClicked", function() {
                if (gameState.pendingClicks > 0) {
                    saveClickHistory(userId, Date.now(), gameState.clickCounter);
                }
                console.log("App closing, pendingClicks=" + gameState.pendingClicks);
                window.Telegram.WebApp.close();
            });
        }

        // Start the app
        startApp();
    </script>
</body>
</html>
