<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>clicker123</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <style>
      :root {
         --tg-theme-bg-color: #ffffff;
         --tg-theme-text-color: #000000;
         --tg-theme-hint-color: #999999;
         --tg-theme-link-color: #007bff;
         --tg-theme-button-color: #007bff;
         --tg-theme-button-text-color: #ffffff;
      }

      body {
         margin: 0;
         font-family: Arial, sans-serif;
         color: var(--tg-theme-text-color);
         background: var(--tg-theme-bg-color);
         display: flex;
         flex-direction: column;
         align-items: center;
         min-height: 100vh;
         font-size: 18px;
      }

      .content {
         flex: 1;
         padding: 20px;
         width: 100%;
         max-width: 600px;
         box-sizing: border-box;
         overflow-y: auto;
      }

      .tabs {
         display: flex;
         position: fixed;
         bottom: 0;
         width: 100%;
         max-width: 600px;
         background: var(--tg-theme-bg-color);
         box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      }

      .tab {
         flex: 1;
         padding: 15px;
         text-align: center;
         cursor: pointer;
         border-top: 2px solid transparent;
         transition: all 0.3s;
      }

      .tab.active {
         border-top: 2px solid var(--tg-theme-button-color);
         background: #f5f5f5;
      }

      .image-button {
         width: 200px;
         height: 200px;
         border: none;
         background-image: url('https://gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-znachok-bitkoina-na-prozrachnom-fone-15.png');
         background-size: cover;
         cursor: pointer;
         transition: transform 0.2s;
      }

      .image-button:active {
         transform: scale(0.95);
      }

      .button {
         background: var(--tg-theme-button-color);
         color: var(--tg-theme-button-text-color);
         border: none;
         padding: 10px 20px;
         border-radius: 5px;
         font-size: 16px;
         cursor: pointer;
         margin: 10px 0;
      }

      .energy-bar {
         width: 100%;
         height: 20px;
         background: #ddd;
         border-radius: 10px;
         overflow: hidden;
         margin: 10px 0;
      }

      .energy-fill {
         height: 100%;
         background: var(--tg-theme-button-color);
         transition: width 0.3s;
      }

      #balance, #energy {
         font-size: 24px;
         font-weight: bold;
         margin: 10px 0;
      }

      .boost-item {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: 10px;
         border-bottom: 1px solid #eee;
      }

      .boost-item span {
         flex: 1;
      }

      .boost-item .button {
         margin: 0;
      }

      .error-message {
         color: red;
         font-size: 16px;
         margin: 10px 0;
      }
   </style>
</head>
<body>
   <div class="content" id="content1">
      <h1 id="balance">0</h1>
      <div id="energy">Energy: 100/100</div>
      <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="width: 100%"></div></div>
      <button id="click" class="image-button"></button>
      <div id="error" class="error-message" style="display: none;"></div>
   </div>
   <div class="content" id="content2" style="display:none;">
      <h2>Boosts</h2>
      <div id="boosts"></div>
   </div>
   <div class="content" id="content3" style="display:none;">
      <h2>Friends</h2>
      <p>Invite friends to earn bonuses!</p>
      <button class="button invite-friend">Invite Friend</button>
   </div>

   <div class="tabs">
      <div class="tab active" data-tab="1">Click</div>
      <div class="tab" data-tab="2">Boost</div>
      <div class="tab" data-tab="3">Friends</div>
   </div>

   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";
      import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";

      const firebaseConfig = {
         apiKey: "AIzaSyBhLISxR41ZYKyyffiY08c_YtqYQdu85pk",
         authDomain: "test-b5ec3.firebaseapp.com",
         databaseURL: "https://test-b5ec3-default-rtdb.firebaseio.com",
         projectId: "test-b5ec3",
         storageBucket: "test-b5ec3.appspot.com",
         messagingSenderId: "489032935342",
         appId: "1:489032935342:web:922e8c518ad0ff6b6eca3f",
         measurementId: "G-YNQM9CV4P3"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const tg = window.Telegram.WebApp;
      tg.expand();

      // Game state
      let serverBalance = 0;
      let localBalance = 0;
      let serverEnergy = 100;
      let localEnergy = 100;
      let maxEnergy = 100;
      let clickPower = 1;
      let rechargeRate = 1;
      let passiveIncome = 0;
      let loginTimestamps = [];
      let clickBalanceHistory = [];
      let boosts = {
         energy_limit: [],
         multiply_per_click: [],
         passive: { card1: [], card2: [] },
         recharge_energy: []
      };
      let userId = null;
      const OFFLINE_LIMIT_HOURS = 12;

      // Boost configurations
      const BOOST_CONFIG = {
         energy_limit: {
            name: "Energy Limit",
            levels: [100, 200, 300, 400, 500],
            cost: level => level * 100,
            apply: (level, state) => { state.maxEnergy = level; }
         },
         multiply_per_click: {
            name: "Click Power",
            levels: [1, 2, 3, 4, 5],
            cost: level => level * 100,
            apply: (level, state) => { state.clickPower = level; }
         },
         passive_card1: {
            name: "Passive Card 1",
            levels: [0, 1, 2, 3, 4],
            cost: level => level * 500,
            apply: (level, state) => { state.passiveIncome += level; }
         },
         passive_card2: {
            name: "Passive Card 2",
            levels: [0, 1, 2, 3, 4],
            cost: level => level * 1000,
            apply: (level, state) => { state.passiveIncome += level; }
         },
         recharge_energy: {
            name: "Recharge Speed",
            levels: [1, 2, 3, 4, 5],
            cost: level => level * 200,
            apply: (level, state) => { state.rechargeRate = level; }
         }
      };

      // Show error message
      function showError(message) {
         const errorDiv = document.getElementById("error");
         errorDiv.innerText = message;
         errorDiv.style.display = "block";
         setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
      }

      // Initialize application
      async function startApp() {
         // Extract pass1 and id1 from URL
         const urlParams = new URLSearchParams(window.location.search);
         const pass1 = urlParams.get("pass1");
         const id1 = urlParams.get("id1");
         console.log("URL:", window.location.search); // log
         console.log("Extracted pass1:", pass1, "id1:", id1); // log

         // Get Telegram user ID
         userId = tg.initDataUnsafe.user?.id;
         console.log("User ID:", userId); // log

         // Validate userId and id1
         if (!userId || !pass1 || !id1 || userId.toString() !== id1) {
            console.log("Validation failed: userId, pass1, or id1 missing, or userId !== id1"); // log
            showError("Error: Invalid user ID or parameters");
            tg.close();
            return;
         }

         // Authenticate with Firebase
         const email = userId + "@example.com";
         console.log("Attempting to authenticate with email:", email); // log
         try {
            const userCredential = await signInWithEmailAndPassword(auth, email, pass1);
            console.log("Authenticated user, UID:", userCredential.user.uid); // log
            if (userCredential.user.uid !== userId.toString()) {
               console.error("UID mismatch:", userCredential.user.uid, "!=", userId); // log
               showError("Authentication error: UID mismatch");
               tg.close();
               return;
            }
            initializeUserData();
         } catch (error) {
            console.error("Authentication error:", error.code, error.message); // log
            showError("Authentication failed: " + error.message);
            tg.close();
         }
      }

      // Initialize user data
      function initializeUserData() {
         console.log("Initializing user data for userId:", userId); // log
         const userRef = ref(db, "users/" + userId);
         onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
               const data = snapshot.val();
               serverBalance = data.balance || 0;
               serverEnergy = data.energy || maxEnergy;
               loginTimestamps = decompressTimestamps(data.login_timestamps || []);
               clickBalanceHistory = decompressHistory(data.click_balance_history || []);
               boosts = {
                  energy_limit: data.boosts?.energy_limit || [],
                  multiply_per_click: decompressTimestamps(data.boosts?.multiply_per_click || []),
                  passive: {
                     card1: decompressTimestamps(data.boosts?.passive?.card1 || []),
                     card2: decompressTimestamps(data.boosts?.passive?.card2 || [])
                  },
                  recharge_energy: decompressTimestamps(data.boosts?.recharge_energy || [])
               };
               applyBoosts();
               console.log("Loaded user data:", data); // log
               initializeLocalStorage();
               updateLoginTimestamps();
               recalculatePassiveIncome();
               updateUI();
               renderBoosts();
            } else {
               console.log("No user data, initializing new"); // log
               serverEnergy = maxEnergy;
               loginTimestamps = [Date.now()];
               saveData();
               initializeLocalStorage();
               updateUI();
               renderBoosts();
            }
         }, (error) => {
            console.error("Firebase read error:", error.code, error.message); // log
            showError("Failed to load user data: " + error.message);
         });
      }

      // Apply boosts to game state
      function applyBoosts() {
         maxEnergy = 100;
         clickPower = 1;
         rechargeRate = 1;
         passiveIncome = 0;
         boosts.energy_limit.forEach(b => BOOST_CONFIG.energy_limit.apply(b.level, { maxEnergy }));
         boosts.multiply_per_click.forEach((_, i) => BOOST_CONFIG.multiply_per_click.apply(i + 1, { clickPower }));
         boosts.passive.card1.forEach((_, i) => BOOST_CONFIG.passive_card1.apply(i + 1, { passiveIncome }));
         boosts.passive.card2.forEach((_, i) => BOOST_CONFIG.passive_card2.apply(i + 1, { passiveIncome }));
         boosts.recharge_energy.forEach((_, i) => BOOST_CONFIG.recharge_energy.apply(i + 1, { rechargeRate }));
         console.log("Applied boosts:", { maxEnergy, clickPower, rechargeRate, passiveIncome }); // log
      }

      // Initialize local storage
      function initializeLocalStorage() {
         console.log("Initializing local storage"); // log
         const storedData = localStorage.getItem(clicker123_${userId}
         if (storedData) {
            const data = JSON.parse(storedData);
            localBalance = data.localBalance || serverBalance;
            localEnergy = data.localEnergy || serverEnergy;
            console.log("Loaded local storage:", data); // log
         } else {
            localBalance = serverBalance;
            localEnergy = serverEnergy;
            saveLocalStorage();
         }
      }

      // Save to local storage
      function saveLocalStorage() {
         console.log("Saving to local storage"); // log
         localStorage.setItem(clicker123_${userId}, JSON.stringify({
            localBalance,
            localEnergy
         }));
      }

      // Compress timestamps (delta encoding)
      function compressTimestamps(timestamps) {
         if (timestamps.length === 0) return [];
         const compressed = [timestamps[0] || 0];
         for (let i = 1; i < timestamps.length; i++) {
            compressed.push(timestamps[i] - timestamps[i - 1]);
         }
         return compressed;
      }

      // Decompress timestamps
      function decompressTimestamps(compressed) {
         if (compressed.length === 0) return [];
         const timestamps = [compressed[0]];
         for (let i = 1; i < compressed.length; i++) {
            timestamps.push(timestamps[i - 1] + compressed[i]);
         }
         return timestamps;
      }

      // Compress history
      function compressHistory(history) {
         if (history.length === 0) return [];
         const compressed = history.length > 0 ? [{ t: history[0].t, b: history[0].b }] : [];
         for (let i = 1; i < history.length; i++) {
            compressed.push({
               t: history[i].t - history[i - 1].t,
               b: history[i].b
            });
         }
         return compressed;
      }

      // Decompress history
      function decompressHistory(compressed) {
         if (compressed.length === 0) return [];
         const history = compressed.length > 0 ? [{ t: compressed[0].t, b: compressed[0].b }] : [];
         for (let i = 1; i < compressed.length; i++) {
            history.push({
               t: history[i - 1].t + compressed[i].t,
               b: compressed[i].b
            });
         }
         return history;
      }

      // Update login timestamps
      function updateLoginTimestamps() {
         console.log("Updating login timestamps"); // log
         loginTimestamps.push(Date.now());
         saveData();
      }

      // Recalculate passive income
      function recalculatePassiveIncome() {
         console.log("Recalculating passive income"); // log
         const now = Date.now();
         let totalIncome = 0;
         for (const cardId in boosts.passive) {
            boosts.passive[cardId].forEach((timestamp, level) => {
               const elapsed = Math.min(now - timestamp, OFFLINE_LIMIT_HOURS * 60 * 60 * 1000);
               totalIncome += (level + 1) * (elapsed / 1000);
            });
         }
         localBalance += totalIncome;
         serverBalance = localBalance;
         saveData();
         saveLocalStorage();
         console.log("Passive income added:", totalIncome, "New server balance:", serverBalance); // log
      }

      // Click handler
      document.getElementById("click").addEventListener("click", () => {
         console.log("Click button pressed, local energy:", localEnergy); // log
         if (localEnergy >= 1) {
            localEnergy -= 1;
            localBalance += clickPower;
            serverEnergy = localEnergy;
            serverBalance = localBalance;
            clickBalanceHistory.push({ t: Date.now(), b: Math.floor(localBalance) });
            console.log("New local balance:", localBalance, "New local energy:", localEnergy); // log
            saveData();
            saveLocalStorage();
            updateUI();
         } else {
            console.log("Not enough energy"); // log
            showError("Not enough energy!");
         }
      });

      // Energy regeneration
      setInterval(() => {
         if (localEnergy < maxEnergy) {
            localEnergy = Math.min(localEnergy + rechargeRate, maxEnergy);
            console.log("Local energy regenerated to:", localEnergy); // log
            saveLocalStorage();
            updateUI();
         }
      }, 1000);

      // Passive income update
      setInterval(() => {
         if (passiveIncome > 0) {
            localBalance += passiveIncome;
            console.log("Local passive income added:", passiveIncome, "New local balance:", localBalance); // log
            saveLocalStorage();
            updateUI();
         }
      }, 1000);

      // Save data to Firebase
      function saveData() {
         if (!userId) {
            console.log("No userId, skipping save"); // log
            return;
         }
         console.log("Saving data for userId:", userId); // log
         set(ref(db, "users/" + userId), {
            balance: serverBalance,
            energy: serverEnergy,
            boosts: {
               energy_limit: boosts.energy_limit,
               multiply_per_click: compressTimestamps(boosts.multiply_per_click),
               passive: {
                  card1: compressTimestamps(boosts.passive.card1),
                  card2: compressTimestamps(boosts.passive.card2)
               },
               recharge_energy: compressTimestamps(boosts.recharge_energy)
            },
            login_timestamps: compressTimestamps(loginTimestamps),
            click_balance_history: compressHistory(clickBalanceHistory)
         }).catch((error) => {
            console.error("Error saving data:", error.code, error.message); // log
            showError("Failed to save data: " + error.message);
         });
      }

      // Update UI
      function updateUI() {
         console.log("Updating UI, local balance:", localBalance, "local energy:", localEnergy); // log
         document.getElementById("balance").innerText = Math.floor(localBalance);
         document.getElementById("energy").innerText = Energy: ${Math.floor(localEnergy)}/${maxEnergy};
         document.getElementById("energy-fill").style.width = (localEnergy / maxEnergy) * 100 + "%";
      }

      // Render boosts
      function renderBoosts() {
         const boostsDiv = document.getElementById("boosts");
         boostsDiv.innerHTML = "";
         Object.entries(BOOST_CONFIG).forEach(([key, config]) => {
            const currentLevel = getCurrentBoostLevel(key);
            const nextLevel = config.levels[currentLevel];
            if (nextLevel !== undefined) {
               const cost = config.cost(nextLevel);
               const item = document.createElement("div");
               item.className = "boost-item";
               item.innerHTML = `
                  <span>${config.name} (Level ${currentLevel} → ${nextLevel})</span>
                  <button class="button boost-button" data-boost="${key}">Buy (${cost})</button>
               `;
               boostsDiv.appendChild(item);
            }
         });
         document.querySelectorAll(".boost-button").forEach(button => {
            button.addEventListener("click", () => {
               const boostKey = button.getAttribute("data-boost");
               buyBoost(boostKey);
            });
         });
      }

      // Get current boost level
      function getCurrentBoostLevel(key) {
         if (key.startsWith("passive_")) {
            const cardId = key.replace("passive_", "");
            return boosts.passive[cardId].length;
         }
         return boosts[key.replace("_", "")].length;
      }

      // Buy boost
      // Buy boost
      function buyBoost(boostKey) {
         console.log("Attempting to buy boost:", boostKey); // log
         const config = BOOST_CONFIG[boostKey];
         const currentLevel = getCurrentBoostLevel(boostKey);
         const nextLevel = config.levels[currentLevel];
         if (nextLevel === undefined) {
            console.log("Max level reached for:", boostKey); // log
            showError("Max level reached!");
            return;
         }
         const cost = config.cost(nextLevel);
         if (localBalance >= cost) {
            localBalance -= cost;
            serverBalance = localBalance;
            const timestamp = Date.now();
            if (boostKey.startsWith("passive_")) {
               const cardId = boostKey.replace("passive_", "");
               boosts.passive[cardId].push(timestamp);
            } else if (boostKey === "energy_limit") {
               boosts.energy_limit.push({ level: nextLevel, t: timestamp });
            } else {
               boosts[boostKey.replace("_", "")].push(timestamp);
            }
            applyBoosts();
            saveData();
            saveLocalStorage();
            updateUI();
            renderBoosts();
            console.log("Bought boost:", boostKey, "Level:", nextLevel); // log
         } else {
            console.log("Not enough coins for boost"); // log
            showError("Not enough coins!");
         }
      }

      // Invite friend
      function inviteFriend() {
         console.log("Generating invite link for userId:", userId); // log
         const inviteLink = "https://t.me/your_bot?start=" + userId;
         const shareUrl = "https://t.me/share/url?url=" + encodeURIComponent(inviteLink) + "&text=Join%20my%20game!";
         console.log("Opening Telegram share URL:", shareUrl); // log
         tg.openTelegramLink(shareUrl);
      }

      // Tab navigation
      function showTab(tabIndex) {
         console.log("Switching to tab:", tabIndex); // log
         document.querySelectorAll(".content").forEach((content, index) => {
            content.style.display = index === tabIndex - 1 ? "block" : "none";
         });
         document.querySelectorAll(".tab").forEach((tab, index) => {
            tab.classList.toggle("active", index === tabIndex - 1);
         });
      }

      // Bind tab events
      document.querySelector>(".tab").forEach(tab => {
         tab.addEventListener("click", () => {
            const tabIndex = parseInt(tab.getAttribute("data-tab"));
            console.log("Tab clicked, index:", tabIndex); // log
            showTab(tabIndex);
         });
      });

      // Bind invite button
      document.querySelector(".invite-friend").addEventListener("click", () => {
         console.log("Invite friend button clicked"); // log
         inviteFriend();
      });

      // Start application
      startApp();
   </script>
</body>
</html>
