<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clicker123</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Ваш существующий CSS без изменений */
    </style>
</head>
<body>
    <div class="content" id="content1">
        <h1 id="balance">0</h1>
        <div id="energy">Energy: 100/100</div>
        <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="width: 100%"></div></div>
        <button id="click" class="image-button"></button>
    </div>
    <div class="content" id="content2" style="display:none;">
        <h2>Boosts</h2>
        <div id="boosts">
            <div class="boost-item">
                <span>Click Power +1</span>
                <button class="button boost-multiply-per-click">Buy (<span class="cost">100</span>)</button>
            </div>
            <div class="boost-item">
                <span>Energy Limit +100</span>
                <button class="button boost-energy-limit">Buy (<span class="cost">200</span>)</button>
            </div>
            <div class="boost-item">
                <span>Faster Energy Recharge</span>
                <button class="button boost-recharge-energy">Buy (<span class="cost">150</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income (Card 1)</span>
                <button class="button boost-passive-card1">Buy (<span class="cost">300</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income (Card 2)</span>
                <button class="button boost-passive-card2">Buy (<span class="cost">500</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income (Card 3)</span>
                <button class="button boost-passive-card3">Buy (<span class="cost">1000</span>)</button>
            </div>
        </div>
    </div>
    <div class="content" id="content3" style="display:none;">
        <h2>Friends</h2>
        <p>Invite friends to earn bonuses!</p>
        <button class="button invite-friend">Invite Friend</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="1">Click</div>
        <div class="tab" data-tab="2">Boost</div>
        <div class="tab" data-tab="3">Friends</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhLISxR41ZYKyyffiY08c_YtqYQdu85pk",
            authDomain: "test-b5ec3.firebaseapp.com",
            databaseURL: "https://test-b5ec3-default-rtdb.firebaseio.com",
            projectId: "test-b5ec3",
            storageBucket: "test-b5ec3.appspot.com",
            messagingSenderId: "489032935342",
            appId: "1:489032935342:web:922e8c518ad0ff6b6eca3f",
            measurementId: "G-YNQM9CV4P3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userId = tg.initDataUnsafe.user?.id;
        let balance = 0;
        let serverBalance = 0;
        let energy = 100;
        let maxEnergy = 100;
        let clickPower = 1;
        let rechargeRate = 1; // Энергия в секунду
        let passiveIncome = { card1: 0, card2: 0, card3: 0 };
        let lastClickTime = 0;
        let lastServerSync = 0;
        const SYNC_INTERVAL = 60000; // Синхронизация каждые 60 секунд
        const MIN_CLICK_INTERVAL = 50; // Защита от множественных кликов (50 мс)

        // Извлечение pass1 из URL
        const urlParams = new URLSearchParams(window.location.search);
        const pass1 = urlParams.get("pass1");

        if (!userId || !pass1) {
            alert("Error: Unable to get Telegram user ID or password");
            tg.close();
            return;
        }

        // Аутентификация
        const email = userId + "@example.com";
        signInWithEmailAndPassword(auth, email, pass1)
            .then((userCredential) => {
                initializeUserData();
            })
            .catch((error) => {
                alert("Authentication failed: " + error.message);
                tg.close();
            });

        // Инициализация данных пользователя
        function initializeUserData() {
            const userRef = ref(db, "users/" + userId);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    balance = data.balance || 0;
                    serverBalance = data.server_balance || 0;
                    energy = data.energy || maxEnergy;
                    maxEnergy = data.max_energy || 100;
                    clickPower = data.boosts?.multiply_per_click?.level || 1;
                    rechargeRate = data.boosts?.recharge_energy?.level || 1;
                    passiveIncome.card1 = data.boosts?.passive_income?.card1?.level || 0;
                    passiveIncome.card2 = data.boosts?.passive_income?.card2?.level || 0;
                    passiveIncome.card3 = data.boosts?.passive_income?.card3?.level || 0;
                    lastServerSync = data.last_server_sync || Date.now();
                    updateUI();
                    syncServerBalance();
                } else {
                    saveData();
                    updateUI();
                }
            }, (error) => {
                alert("Failed to load user data: " + error.message);
            });
        }

        // Обработчик кликов
        document.getElementById("click").addEventListener("click", () => {
            const now = Date.now();
            if (now - lastClickTime < MIN_CLICK_INTERVAL) return; // Защита от спама
            lastClickTime = now;

            if (energy >= 1) {
                energy -= 1;
                balance += clickPower;
                serverBalance += clickPower;
                push(ref(db, users/${userId}/click_balance_history), {
                    t: now,
                    b: serverBalance
                });
                saveData();
                updateUI();
            } else {
                alert("Not enough energy!");
            }
        });

        // Регенерация энергии
        setInterval(() => {
            if (energy < maxEnergy) {
                energy = Math.min(energy + rechargeRate / 10, maxEnergy); // Делим на 10 для плавности
                updateUI();
            }
        }, 100);

        // Пассивный доход
        setInterval(() => {
            const totalPassive = passiveIncome.card1 + passiveIncome.card2 + passiveIncome.card3;
            if (totalPassive > 0) {
                balance += totalPassive / 10; // Делим на 10 для плавности
                saveData();
                updateUI();
            }
        }, 100);

        // Синхронизация с сервером
        function syncServerBalance() {
            const now = Date.now();
            if (now - lastServerSync < SYNC_INTERVAL) return;

            lastServerSync = now;
            const userRef = ref(db, users/${userId}/click_balance_history);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const history = snapshot.val();
                    let calculatedBalance = 0;
                    Object.values(history).forEach(entry => {
                        calculatedBalance += entry.b;
                    });

                    if (Math.abs(balance - calculatedBalance) > 1000) {
                        alert("Warning: Balance discrepancy detected. Please contact support.");
                    }
                    if (calculatedBalance < 0) {
                        alert("Critical error: Negative balance detected. Account suspended.");
                        tg.close();
                    }
                    serverBalance = calculatedBalance;
                    saveData();
                }
            }, { onlyOnce: true });
        }

        // Сохранение данных
        function saveData() {
            if (!userId) return;
            set(ref(db, "users/" + userId), {
                balance,
                server_balance: serverBalance,
                energy,
                max_energy: maxEnergy,
                boosts: {
                    energy_limit: { level: maxEnergy, purchases: [] },
                    multiply_per_click: { level: clickPower, purchases: [] },
                    recharge_energy: { level: rechargeRate, purchases: [] },
                    passive_income: {
                        card1: { level: passiveIncome.card1, purchases: [] },
                        card2: { level: passiveIncome.card2, purchases: [] },
                        card3: { level: passiveIncome.card3, purchases: [] }
                    }
                },
                last_server_sync: lastServerSync
            }).catch((error) => {
                console.error("Error saving data:", error);
            });
        }

        // Обновление UI
        function updateUI() {
            document.getElementById("balance").innerText = Math.floor(balance);
            document.getElementById("energy").innerText = Energy: ${Math.floor(energy)}/${maxEnergy};
            document.getElementById("energy-fill").style.width = (energy / maxEnergy) * 100 + "%";
        }

        // Покупка буста
        function buyBoost(type, cost, updateFn) {
            if (balance >= cost) {
                balance -= cost;
                updateFn();
                push(ref(db, users/${userId}/boosts/${type}/purchases), {
                    t: Date.now(),
                    cost
                });
                saveData();
                updateUI();
                syncServerBalance();
            } else {
                alert("Not enough coins!");
            }
        }

        // Привязка кнопок бустов
        document.querySelector(".boost-multiply-per-click").addEventListener("click", () => {
            buyBoost("multiply_per_click", 100, () => clickPower += 1);
        });
        document.querySelector(".boost-energy-limit").addEventListener("click", () => {
            buyBoost("energy_limit", 200, () => maxEnergy += 100);
        });
        document.querySelector(".boost-recharge-energy").addEventListener("click", () => {
            buyBoost("recharge_energy", 150, () => rechargeRate += 0.5);
        });
        document.querySelector(".boost-passive-card1").addEventListener("click", () => {
            buyBoost("passive_income/card1", 300, () => passiveIncome.card1 += 1);
        });
        document.querySelector(".boost-passive-card2").addEventListener("click", () => {
            buyBoost("passive_income/card2", 500, () => passiveIncome.card2 += 2);
        });
        document.querySelector(".boost-passive-card3").addEventListener("click", () => {
            buyBoost("passive_income/card3", 1000, () => passiveIncome.card3 += 5);
        });

        // Приглашение друга
        document.querySelector(".invite-friend").addEventListener("click", () => {
            const inviteLink = https://t.me/your_bot?start=${userId};
            const shareUrl = https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=Join%20my%20game!;
            tg.openTelegramLink(shareUrl);
        });

        // Навигация по вкладкам
        document.querySelectorAll(".tab").forEach(tab => {
            tab.addEventListener("click", () => {
                const tabIndex = parseInt(tab.getAttribute("data-tab"));
                document.querySelectorAll(".content").forEach((content, index) => {
                    content.style.display = index === tabIndex - 1 ? "block" : "none";
                });
                document.querySelectorAll(".tab").forEach((t, index) => {
                    t.classList.toggle("active", index === tabIndex - 1);
                });
            });
        });
    </script>
</body>
</html>
