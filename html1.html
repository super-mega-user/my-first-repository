<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clicker123</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #007bff;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-size: 18px;
        }

        .content {
            flex: 1;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            background: var(--tg-theme-bg-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-top: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-top: 2px solid var(--tg-theme-button-color);
            background: #f5f5f5;
        }

        .image-button {
            width: 200px;
            height: 200px;
            border: none;
            background-image: url('https://gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-znachok-bitkoina-na-prozrachnom-fone-15.png');
            background-size: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-button:active {
            transform: scale(0.95);
        }

        .button {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .energy-fill {
            height: 100%;
            background: var(--tg-theme-button-color);
            transition: width 0.3s;
        }

        #balance, #energy {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .boost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="content" id="content1">
        <h1 id="balance">0</h1>
        <div id="energy">Energy: 100/100</div>
        <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="width: 100%"></div></div>
        <button id="click" class="image-button"></button>
    </div>
    <div class="content" id="content2" style="display:none;">
        <h2>Boosts</h2>
        <div id="boosts">
            <div class="boost-item">
                <span>Click Power +1 (Level <span class="level-multiply-per-click">1</span>)</span>
                <button class="button boost-multiply-per-click">Buy (<span class="cost-multiply-per-click">100</span>)</button>
            </div>
            <div class="boost-item">
                <span>Energy Limit +100 (Level <span class="level-energy-limit">1</span>)</span>
                <button class="button boost-energy-limit">Buy (<span class="cost-energy-limit">200</span>)</button>
            </div>
            <div class="boost-item">
                <span>Faster Energy Recharge (Level <span class="level-recharge-energy">1</span>)</span>
                <button class="button boost-recharge-energy">Buy (<span class="cost-recharge-energy">150</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 1 (Level <span class="level-passive-card1">0</span>)</span>
                <button class="button boost-passive-card1">Buy (<span class="cost-passive-card1">300</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 2 (Level <span class="level-passive-card2">0</span>)</span>
                <button class="button boost-passive-card2">Buy (<span class="cost-passive-card2">500</span>)</button>
            </div>
            <div class="boost-item">
                <span>Passive Income Card 3 (Level <span class="level-passive-card3">0</span>)</span>
                <button class="button boost-passive-card3">Buy (<span class="cost-passive-card3">1000</span>)</button>
            </div>
        </div>
    </div>
    <div class="content" id="content3" style="display:none;">
        <h2>Friends</h2>
        <p>Invite friends to earn bonuses!</p>
        <button class="button invite-friend">Invite Friend</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="1">Click</div>
        <div class="tab" data-tab="2">Boost</div>
        <div class="tab" data-tab="3">Friends</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhLISxR41ZYKyyffiY08c_YtqYQdu85pk",
            authDomain: "test-b5ec3.firebaseapp.com",
            databaseURL: "https://test-b5ec3-default-rtdb.firebaseio.com",
            projectId: "test-b5ec3",
            storageBucket: "test-b5ec3.appspot.com",
            messagingSenderId: "489032935342",
            appId: "1:489032935342:web:922e8c518ad0ff6b6eca3f",
            measurementId: "G-YNQM9CV4P3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userId = tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? tg.initDataUnsafe.user.id : null;
        let balance = 0; // –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –∏–∑ Firebase
        let serverBalance = 0;
        let energy = 100;
        let maxEnergy = 100;
        let rechargeRate = 1;
        let clickPower = 1;
        let passiveIncome = { card1: 0, card2: 0, card3: 0 };
        let lastClickTime = 0;
        let lastServerSync = 0;
        let lastLoginTime = 0;
        const SYNC_INTERVAL = 60000;
        const MIN_CLICK_INTERVAL = 50;

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ pass1
        const urlParams = new URLSearchParams(window.location.search);
        const pass1 = urlParams.get("pass1");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ userId –∏ pass1
        function initializeAppLogic() {
            if (!userId || !pass1) {
                alert("Error: Unable to get Telegram user ID or password");
                tg.close();
                return false;
            }
            return true;
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (initializeAppLogic()) {
            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            const email = userId + "@example.com";
            signInWithEmailAndPassword(auth, email, pass1)
                .then(function(userCredential) {
                    initializeUserData();
                    logLogin();
                })
                .catch(function(error) {
                    alert("Authentication failed: " + error.message);
                    tg.close();
                });
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞ —Å –¥–µ–ª—å—Ç–∞-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function logLogin() {
            var now = Date.now();
            var deltaT = lastLoginTime ? now - lastLoginTime : 0;
            lastLoginTime = now;
            push(ref(db, "users/" + userId + "/login_timestamps"), deltaT)
                .catch(function(error) {
                    console.error("Error logging login: ", error);
                });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        function initializeUserData() {
            var userRef = ref(db, "users/" + userId);
            onValue(userRef, function(snapshot) {
                if (snapshot.exists()) {
                    var data = snapshot.val();
                    serverBalance = data.server_balance || 0;
                    balance = serverBalance; // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                    energy = data.energy || maxEnergy;
                    maxEnergy = data.max_energy || 100;
                    rechargeRate = data.recharge_rate || 1;
                    clickPower = data.boosts && data.boosts.multiply_per_click ? data.boosts.multiply_per_click.level || 1 : 1;
                    passiveIncome.card1 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card1 ? data.boosts.passive_income.card1.level || 0 : 0;
                    passiveIncome.card2 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card2 ? data.boosts.passive_income.card2.level || 0 : 0;
                    passiveIncome.card3 = data.boosts && data.boosts.passive_income && data.boosts.passive_income.card3 ? data.boosts.passive_income.card3.level || 0 : 0;
                    lastServerSync = data.last_server_sync || Date.now();
                    console.log("Firebase sync: balance=" + balance + ", energy=" + energy); // –û—Ç–ª–∞–¥–∫–∞
                    updateUI();
                    syncServerBalance();
                } else {
                    saveData();
                    updateUI();
                }
            }, function(error) {
                alert("Failed to load user data: " + error.message);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
        document.getElementById("click").addEventListener("click", function() {
            var now = Date.now();
            if (now - lastClickTime < MIN_CLICK_INTERVAL) return;
            lastClickTime = now;

            if (energy >= 1) {
                energy -= 1;
                balance += clickPower;
                serverBalance += clickPower;
                console.log("Click: balance=" + balance + ", energy=" + energy); // –û—Ç–ª–∞–¥–∫–∞
                push(ref(db, "users/" + userId + "/click_balance_history"), {
                    delta_t: lastClickTime ? now - lastClickTime : 0,
                    b: clickPower
                }).catch(function(error) {
                    console.error("Error saving click history: ", error);
                });
                saveData();
                updateUI();
            } else {
                alert("Not enough energy!");
            }
        });

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏
        setInterval(function() {
            if (energy < maxEnergy) {
                energy = Math.min(energy + rechargeRate / 10, maxEnergy);
                console.log("Regen: energy=" + energy); // –û—Ç–ª–∞–¥–∫–∞
                saveData();
                updateUI();
            }
        }, 100);

        // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
        setInterval(function() {
            var totalPassive = passiveIncome.card1 + passiveIncome.card2 + passiveIncome.card3;
            if (totalPassive > 0) {
                balance += totalPassive / 10;
                serverBalance += totalPassive / 10;
                console.log("Passive: balance=" + balance); // –û—Ç–ª–∞–¥–∫–∞
                saveData();
                updateUI();
            }
        }, 100);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        function syncServerBalance() {
            var now = Date.now();
            if (now - lastServerSync < SYNC_INTERVAL) return;

            lastServerSync = now;
            var historyRef = ref(db, "users/" + userId + "/click_balance_history");
            onValue(historyRef, function(snapshot) {
                if (snapshot.exists()) {
                    var history = snapshot.val();
                    var calculatedBalance = 0;
                    Object.values(history).forEach(function(entry) {
                        calculatedBalance += entry.b;
                    });

                    if (Math.abs(balance - calculatedBalance) > 1000) {
                        alert("Warning: Balance discrepancy detected. Please contact support.");
                    }
                    if (calculatedBalance < 0) {
                        alert("Critical error: Negative balance detected. Account suspended.");
                        tg.close();
                    }
                    serverBalance = calculatedBalance;
                    balance = serverBalance;
                    console.log("Server sync: balance=" + balance); // –û—Ç–ª–∞–¥–∫–∞
                    saveData();
                }
            }, { onlyOnce: true });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveData() {
            if (!userId) return;
            set(ref(db, "users/" + userId), {
                server_balance: serverBalance,
                energy: energy,
                max_energy: maxEnergy,
                recharge_rate: rechargeRate,
                boosts: {
                    energy_limit: { level: maxEnergy, purchases: [] },
                    multiply_per_click: { level: clickPower, purchases: [] },
                    recharge_energy: { level: rechargeRate, purchases: [] },
                    passive_income: {
                        card1: { level: passiveIncome.card1, purchases: [] },
                        card2: { level: passiveIncome.card2, purchases: [] },
                        card3: { level: passiveIncome.card3, purchases: [] }
                    }
                },
                last_server_sync: lastServerSync
            }).catch(function(error) {
                console.error("Error saving data: ", error);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            document.getElementById("balance").innerText = Math.floor(balance);
            document.getElementById("energy").innerText = "Energy: " + Math.floor(energy) + "/" + maxEnergy;
            document.getElementById("energy-fill").style.width = (energy / maxEnergy) * 100 + "%";

            document.querySelector(".level-multiply-per-click").innerText = clickPower;
            document.querySelector(".cost-multiply-per-click").innerText = Math.floor(100 * clickPower * clickPower);
            document.querySelector(".level-energy-limit").innerText = maxEnergy / 100;
            document.querySelector(".cost-energy-limit").innerText = Math.floor(200 * (maxEnergy / 100) * (maxEnergy / 100));
            document.querySelector(".level-recharge-energy").innerText = rechargeRate;
            document.querySelector(".cost-recharge-energy").innerText = Math.floor(150 * rechargeRate * rechargeRate);
            document.querySelector(".level-passive-card1").innerText = passiveIncome.card1;
            document.querySelector(".cost-passive-card1").innerText = Math.floor(300 * (passiveIncome.card1 + 1) * (passiveIncome.card1 + 1));
            document.querySelector(".level-passive-card2").innerText = passiveIncome.card2;
            document.querySelector(".cost-passive-card2").innerText = Math.floor(500 * (passiveIncome.card2 + 1) * (passiveIncome.card2 + 1));
            document.querySelector(".level-passive-card3").innerText = passiveIncome.card3;
            document.querySelector(".cost-passive-card3").innerText = Math.floor(1000 * (passiveIncome.card3 + 1) * (passiveIncome.card3 + 1));
        }

        // –ü–æ–∫—É–ø–∫–∞ –±—É—Å—Ç–∞
        function buyBoost(type, path, cost, updateFn) {
            console.log("Buy attempt: balance=" + balance + ", cost=" + cost); // –û—Ç–ª–∞–¥–∫–∞
            if (balance >= cost) {
                balance -= cost;
                serverBalance -= cost;
                updateFn();
                var now = Date.now();
                push(ref(db, "users/" + userId + "/boosts/" + path + "/purchases"), {
                    t: now,
                    cost: cost,
                    delta_t: lastClickTime ? now - lastClickTime : 0
                }).catch(function(error) {
                    console.error("Error saving boost " + type + ": ", error);
                });
                saveData();
                updateUI();
                syncServerBalance();
            } else {
                alert("Not enough coins!");
            }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ –±—É—Å—Ç–æ–≤
        document.querySelector(".boost-multiply-per-click").addEventListener("click", function() {
            var cost = Math.floor(100 * clickPower * clickPower);
            buyBoost("multiply_per_click", "multiply_per_click", cost, function() { clickPower += 1; });
        });
        document.querySelector(".boost-energy-limit").addEventListener("click", function() {
            var cost = Math.floor(200 * (maxEnergy / 100) * (maxEnergy / 100));
            buyBoost("energy_limit", "energy_limit", cost, function() { maxEnergy += 100; });
        });
        document.querySelector(".boost-recharge-energy").addEventListener("click", function() {
            var cost = Math.floor(150 * rechargeRate * rechargeRate);
            buyBoost("recharge_energy", "recharge_energy", cost, function() { rechargeRate += 0.5; });
        });
        document.querySelector(".boost-passive-card1").addEventListener("click", function() {
            var cost = Math.floor(300 * (passiveIncome.card1 + 1) * (passiveIncome.card1 + 1));
            buyBoost("passive_income/card1", "passive_income/card1", cost, function() { passiveIncome.card1 += 1; });
        });
        document.querySelector(".boost-passive-card2").addEventListener("click", function() {
            var cost = Math.floor(500 * (passiveIncome.card2 + 1) * (passiveIncome.card2 + 1));
            buyBoost("passive_income/card2", "passive_income/card2", cost, function() { passiveIncome.card2 += 2; });
        });
        document.querySelector(".boost-passive-card3").addEventListener("click", function() {
            var cost = Math.floor(1000 * (passiveIncome.card3 + 1) * (passiveIncome.card3 + 1));
            buyBoost("passive_income/card3", "passive_income/card3", cost, function() { passiveIncome.card3 += 5; });
        });

        // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞
        document.querySelector(".invite-friend").addEventListener("click", function() {
            try {
                var inviteLink = "https://t.me/your_bot?start=" + encodeURIComponent(userId);
                var shareUrl = "https://t.me/share/url?url=" + encodeURIComponent(inviteLink) + "&text=" + encodeURIComponent("Join my game!");
                tg.openTelegramLink(shareUrl);
            } catch (error) {
                console.error("Error generating invite link: ", error);
                alert("Failed to generate invite link. Please try again.");
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
        document.querySelectorAll(".tab").forEach(function(tab) {
            tab.addEventListener("click", function() {
                var tabIndex = parseInt(tab.getAttribute("data-tab"));
                document.querySelectorAll(".content").forEach(function(content, index) {
                    content.style.display = index === tabIndex - 1 ? "block" : "none";
                });
                document.querySelectorAll(".tab").forEach(function(t, index) {
                    t.classList.toggle("active", index === tabIndex - 1);
                });
            });
        });
    </script>
</body>
</html>
