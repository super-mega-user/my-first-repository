<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clicker Game</title>
    <link rel="icon" href="data:,"> <!-- Заглушка для favicon, устраняет ошибку 404 -->
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase UMD SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #007bff;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-size: 18px;
        }
        .content {
            flex: 1;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            background: var(--tg-theme-bg-color);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-top: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-top: 2px solid var(--tg-theme-button-color);
            background: #f5f5f5;
        }
        .image-button {
            width: 200px;
            height: 200px;
            border: none;
            background-image: url('https://gas-kvas.com/grafic/uploads/posts/2024-01/gas-kvas-com-p-znachok-bitkoina-na-prozrachnom-fone-15.png');
            background-size: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .image-button:active {
            transform: scale(0.95);
        }
        .button {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        .energy-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .energy-fill {
            height: 100%;
            background: var(--tg-theme-button-color);
            transition: width 0.3s;
        }
        #balance, #energy {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .boost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .boost-item span {
            flex: 1;
        }
        .boost-item .button {
            margin: 0;
        }
        .error-message {
            color: red;
            font-size: 16px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Главная вкладка: кликер -->
    <div class="content" id="content1">
        <h1 id="balance">0</h1>
        <div id="energy">Energy: 100/100</div>
        <div class="energy-bar"><div class="energy-fill" id="energy-fill" style="width: 100%"></div></div>
        <button id="click" class="image-button"></button>
        <div id="error" class="error-message" style="display: none;"></div>
    </div>
    <!-- Вкладка бустов -->
    <div class="content" id="content2" style="display:none;">
        <h2>Boosts</h2>
        <div id="boosts"></div>
    </div>
    <!-- Вкладка друзей -->
    <div class="content" id="content3" style="display:none;">
        <h2>Friends</h2>
        <p>Invite friends to earn bonuses!</p>
        <button class="button invite-friend">Invite Friend</button>
    </div>
    <!-- Навигационные вкладки -->
    <div class="tabs">
        <div class="tab active" data-tab="1">Click</div>
        <div class="tab" data-tab="2">Boost</div>
        <div class="tab" data-tab="3">Friends</div>
    </div>

    <script>
        // Проверка имени файла и логирование запуска
        console.log([${new Date().toISOString()}] Running script from: ${window.location.pathname});
        console.log([${new Date().toISOString()}] Expected file: html1.html);
        if (!window.location.pathname.includes("html1.html")) {
            console.warn([${new Date().toISOString()}] Warning: This script is designed for html1.html, but running from ${window.location.pathname});
        }

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBhLISxR41ZYKyyffiY08c_YtqYQdu85pk",
            authDomain: "test-b5ec3.firebaseapp.com",
            databaseURL: "https://test-b5ec3-default-rtdb.firebaseio.com",
            projectId: "test-b5ec3",
            storageBucket: "test-b5ec3.appspot.com",
            messagingSenderId: "489032935342",
            appId: "1:489032935342:web:922e8c518ad0ff6b6eca3f",
            measurementId: "G-YNQM9CV4P3"
        };

        // Константы
        const OFFLINE_LIMIT_HOURS = 12; // Лимит оффлайн-начислений (часы)
        const BOOST_CONFIG = { // Конфигурация бустов
            energy_limit: {
                name: "Energy Limit",
                levels: [100, 200, 300, 400, 500],
                cost: level => level * 100,
                apply: (level, state) => { state.maxEnergy = level; }
            },
            multiply_per_click: {
                name: "Click Power",
                levels: [1, 2, 3, 4, 5],
                cost: level => level * 100,
                apply: (level, state) => { state.clickPower = level; }
            },
            passive_card1: {
                name: "Passive Card 1",
                levels: [0, 1, 2, 3, 4],
                cost: level => level * 500,
                apply: (level, state) => { state.passiveIncome += level; }
            },
           passive_card2: {
                name: "Passive Card 2",
                levels: [0, 1, 2, 3, 4],
                cost: level => level * 1000,
                apply: (level, state) => { state.passiveIncome += level; }
            },
            recharge_energy: {
                name: "Recharge Speed",
                levels: [1, 2, 3, 4, 5],
                cost: level => level * 200,
                apply: (level, state) => { state.rechargeRate = level; }
            }
        };

        // Инициализация Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Глобальное состояние
        let state = {
            serverBalance: 0,
            localBalance: 0,
            serverEnergy: 100,
            localEnergy: 100,
            maxEnergy: 100,
            clickPower: 1,
            rechargeRate: 1,
            passiveIncome: 0,
            loginTimestamps: [],
            clickBalanceHistory: [],
            boosts: {
                energy_limit: [],
                multiply_per_click: [],
                passive: { card1: [], card2: [] },
                recharge_energy: []
            },
            userId: null
        };

        // Функция отображения ошибок
        function showError(message) {
            console.error([${new Date().toISOString()}] Error: ${message});
            const errorDiv = document.getElementById("error");
            errorDiv.innerText = message;
            errorDiv.style.display = "block";
            setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
        }

        // Запуск приложения
        async function startApp() {
            console.log([${new Date().toISOString()}] Starting app...);
            const urlParams = new URLSearchParams(window.location.search);
            const pass1 = urlParams.get("pass1");
            const id1 = urlParams.get("id1");
            state.userId = tg.initDataUnsafe.user?.id;
            console.log([${new Date().toISOString()}] URL params:, { pass1, id1, userId: state.userId });

            if (!state.userId || !pass1 || !id1 || state.userId.toString() !== id1) {
                showError("Invalid user ID or parameters");
                tg.close();
                return;
            }

            const email = ${state.userId}@example.com;
            console.log([${new Date().toISOString()}] Authenticating with email: ${email});
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, pass1);
                console.log([${new Date().toISOString()}] Authenticated, UID: ${userCredential.user.uid});
                if (userCredential.user.uid !== state.userId.toString()) {
                    showError("Authentication error: UID mismatch");
                    tg.close();
                    return;
                }
                initializeUserData();
            } catch (error) {
                showError(Authentication failed: ${error.message});
            }
        }

        // Инициализация данных пользователя
        function initializeUserData() {
            console.log([${new Date().toISOString()}] Initializing user data for userId: ${state.userId});
            const userRef = db.ref(users/${state.userId});
            userRef.on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    state.serverBalance = data.balance || 0;
                    state.serverEnergy = data.energy || state.maxEnergy;
                    state.loginTimestamps = decompressTimestamps(data.login_timestamps || []);
                    state.clickBalanceHistory = decompressHistory(data.click_balance_history || []);
                    state.boosts = {
                        energy_limit: data.boosts?.energy_limit || [],
                        multiply_per_click: decompressTimestamps(data.boosts?.multiply_per_click || []),
                        passive: {
                            card1: decompressTimestamps(data.boosts?.passive?.card1 || []),
                            card2: decompressTimestamps(data.boosts?.passive?.card2 || [])
                        },
                        recharge_energy: decompressTimestamps(data.boosts?.recharge_energy || [])
                    };
                    console.log([${new Date().toISOString()}] Loaded Firebase data:, data);
                    applyBoosts();
                    initializeLocalStorage();
                    updateLoginTimestamps();
                    recalculatePassiveIncome();
                    updateUI();
                    renderBoosts();
                } else {
                    console.log([${new Date().toISOString()}] No user data, initializing new user);
                    state.serverEnergy = state.maxEnergy;
                    state.loginTimestamps = [Date.now()];
                    saveData();
                    initializeLocalStorage();
                    updateUI();
                    renderBoosts();
                }
            }, (error) => {
                showError(Failed to load user data: ${error.message});
            });
        }

        // Применение бустов
        function applyBoosts() {
            state.maxEnergy = 100;
            state.clickPower = 1;
            state.rechargeRate = 1;
            state.passiveIncome = 0;
            state.boosts.energy_limit.forEach(b => BOOST_CONFIG.energy_limit.apply(b.level, state));
            state.boosts.multiply_per_click.forEach((_, i) => BOOST_CONFIG.multiply_per_click.apply(i + 1, state));
            state.boosts.passive.card1.forEach((_, i) => BOOST_CONFIG.passive_card1.apply(i + 1, state));
            state.boosts.passive.card2.forEach((_, i) => BOOST_CONFIG.passive_card2.apply(i + 1, state));
            state.boosts.recharge_energy.forEach((_, i) => BOOST_CONFIG.recharge_energy.apply(i + 1, state));
            console.log([${new Date().toISOString()}] Applied boosts:, {
                maxEnergy: state.maxEnergy,
                clickPower: state.clickPower,
                rechargeRate: state.rechargeRate,
                passiveIncome: state.passiveIncome
            });
        }

        // Инициализация localStorage
        function initializeLocalStorage() {
            console.log([${new Date().toISOString()}] Initializing localStorage for userId: ${state.userId});
            const storedData = localStorage.getItem(clicker_${state.userId});
            if (storedData) {
                const data = JSON.parse(storedData);
                state.localBalance = data.localBalance || state.serverBalance;
                state.localEnergy = data.localEnergy || state.serverEnergy;
                console.log([${new Date().toISOString()}] Loaded localStorage:, data);
            } else {
                state.localBalance = state.serverBalance;
                state.localEnergy = state.serverEnergy;
                saveLocalStorage();
            }
        }

        // Сохранение в localStorage
        function saveLocalStorage() {
            console.log([${new Date().toISOString()}] Saving to localStorage:, {
                localBalance: state.localBalance,
                localEnergy: state.localEnergy
            });
            localStorage.setItem(clicker_${state.userId}, JSON.stringify({
                localBalance: state.localBalance,
                localEnergy: state.localEnergy
            }));
        }

        // Сжатие временных меток (дельта-кодирование)
        function compressTimestamps(timestamps) {
            if (!timestamps.length) return [];
            const compressed = [timestamps[0] || 0];
            for (let i = 1; i < timestamps.length; i++) {
                compressed.push(timestamps[i] - timestamps[i - 1]);
            }
            return compressed;
        }

        // Декомпрессия временных меток
        function decompressTimestamps(compressed) {
            if (!compressed.length) return [];
            const timestamps = [compressed[0]];
            for (let i = 1; i < compressed.length; i++) {
                timestamps.push(timestamps[i - 1] + compressed[i]);
            }
            return timestamps;
        }

        // Сжатие истории кликов
        function compressHistory(history) {
            if (!history.length) return [];
            const compressed = [{ t: history[0].t, b: history[0].b }];
            for (let i = 1; i < history.length; i++) {
                compressed.push({ t: history[i].t - history[i - 1].t, b: history[i].b });
            }
            return compressed;
        }

        // Декомпрессия истории кликов
        function decompressHistory(compressed) {
            if (!compressed.length) return [];
            const history = [{ t: compressed[0].t, b: compressed[0].b }];
            for (let i = 1; i < compressed.length; i++) {
                history.push({ t: history[i - 1].t + compressed[i].t, b: compressed[i].b });
            }
            return history;
        }

        // Обновление временных меток входа
        function updateLoginTimestamps() {
            console.log([${new Date().toISOString()}] Updating login timestamps);
            state.loginTimestamps.push(Date.now());
            saveData();
        }

        // Пересчет пассивного дохода
        function recalculatePassiveIncome() {
            console.log([${new Date().toISOString()}] Recalculating passive income);
            const now = Date.now();
            let totalIncome = 0;
            for (const cardId in state.boosts.passive) {
                state.boosts.passive[cardId].forEach((timestamp, level) => {
                    const elapsed = Math.min(now - timestamp, OFFLINE_LIMIT_HOURS * 60 * 60 * 1000);
                    totalIncome += (level + 1) * (elapsed / 1000);
                });
            }
            state.localBalance += totalIncome;
            state.serverBalance = state.localBalance;
            console.log([${new Date().toISOString()}] Passive income added: ${totalIncome}, New balance: ${state.localBalance});
            saveData();
            saveLocalStorage();
        }

        // Обработка клика
        document.getElementById("click").addEventListener("click", () => {
            console.log([${new Date().toISOString()}] Click button pressed, current energy: ${state.localEnergy});
            if (state.localEnergy >= 1) {
                state.localEnergy -= 1;
                state.localBalance += state.clickPower;
                state.serverEnergy = state.localEnergy;
                state.serverBalance = state.localBalance;
                state.clickBalanceHistory.push({ t: Date.now(), b: Math.floor(state.localBalance) });
                console.log([${new Date().toISOString()}] Click processed:, {
                    localBalance: state.localBalance,
                    localEnergy: state.localEnergy
                });
                saveData();
                saveLocalStorage();
                updateUI();
            } else {
                showError("Not enough energy!");
            }
        });

        // Регенерация энергии
        setInterval(() => {
            if (state.localEnergy < state.maxEnergy) {
                state.localEnergy = Math.min(state.localEnergy + state.rechargeRate, state.maxEnergy);
                console.log([${new Date().toISOString()}] Energy regenerated: ${state.localEnergy});
                saveLocalStorage();
                updateUI();
            }
        }, 1000);

        // Начисление пассивного дохода
        setInterval(() => {
            if (state.passiveIncome > 0) {
                state.localBalance += state.passiveIncome;
                console.log([${new Date().toISOString()}] Passive income added: ${state.passiveIncome}, New balance: ${state.localBalance});
                saveLocalStorage();
                updateUI();
            }
        }, 1000);

        // Сохранение данных в Firebase
        function saveData() {
            if (!state.userId) {
                console.log([${new Date().toISOString()}] No userId, skipping saveData);
                return;
            }
            console.log([${new Date().toISOString()}] Saving data to Firebase for userId: ${state.userId});
            db.ref(users/${state.userId}).set({
                balance: state.serverBalance,
                energy: state.serverEnergy,
                boosts: {
                    energy_limit: state.boosts.energy_limit,
                    multiply_per_click: compressTimestamps(state.boosts.multiply_per_click),
                    passive: {
                        card1: compressTimestamps(state.boosts.passive.card1),
                        card2: compressTimestamps(state.boosts.passive.card2)
                    },
                    recharge_energy: compressTimestamps(state.boosts.recharge_energy)
                },
                login_timestamps: compressTimestamps(state.loginTimestamps),
                click_balance_history: compressHistory(state.clickBalanceHistory)
            }).catch(error => showError(Failed to save data: ${error.message}));
        }

        // Обновление интерфейса
        function updateUI() {
            console.log([${new Date().toISOString()}] Updating UI:, {
                localBalance: state.localBalance,
                localEnergy: state.localEnergy,
                maxEnergy: state.maxEnergy
            });
            document.getElementById("balance").innerText = Math.floor(state.localBalance);
            document.getElementById("energy").innerText = Energy: ${Math.floor(state.localEnergy)}/${state.maxEnergy};
            document.getElementById("energy-fill").style.width = ${(state.localEnergy / state.maxEnergy) * 100}%;
        }

        // Рендеринг бустов
        function renderBoosts() {
            console.log([${new Date().toISOString()}] Rendering boosts...);
            const boostsDiv = document.getElementById("boosts");
            boostsDiv.innerHTML = "";
            Object.entries(BOOST_CONFIG).forEach(([key, config]) => {
                const currentLevel = getCurrentBoostLevel(key);
                const nextLevel = config.levels[currentLevel];
                if (nextLevel !== undefined) {
                    const cost = config.cost(nextLevel);
                    const item = document.createElement("div");
                    item.className = "boost-item";
                    item.innerHTML = `
                        <span>${config.name} (Level ${currentLevel} → ${nextLevel})</span>
                        <button class="button boost-button" data-boost="${key}">Buy (${cost})</button>
                    `;
                    boostsDiv.appendChild(item);
                    console.log([${new Date().toISOString()}] Rendered boost:, { key, currentLevel, nextLevel, cost });
                }
            });
            document.querySelectorAll(".boost-button").forEach(button => {
                button.addEventListener("click", () => buyBoost(button.getAttribute("data-boost")));
            });
        }

        // Получение текущего уровня буста
        function getCurrentBoostLevel(key) {
            if (key.startsWith("passive_")) {
                const cardId = key.replace("passive_", "");
                return state.boosts.passive[cardId].length;
            }
            return state.boosts[key.replace("_", "")].length;
        }

        // Покупка буста
        function buyBoost(boostKey) {
            console.log([${new Date().toISOString()}] Buying boost: ${boostKey});
            const config = BOOST_CONFIG[boostKey];
            const currentLevel = getCurrentBoostLevel(boostKey);
            const nextLevel = config.levels[currentLevel];
            if (nextLevel === undefined) {
                showError("Max level reached!");
                return;
            }
            const cost = config.cost(nextLevel);
            console.log([${new Date().toISOString()}] Boost details:, { boostKey, currentLevel, nextLevel, cost });
            if (state.localBalance >= cost) {
                state.localBalance -= cost;
                state.serverBalance = state.localBalance;
                const timestamp = Date.now();
                if (boostKey.startsWith("passive_")) {
                    const cardId = boostKey.replace("passive_", "");
                    state.boosts.passive[cardId].push(timestamp);
                } else if (boostKey === "energy_limit") {
                    state.boosts.energy_limit.push({ level: nextLevel, t: timestamp });
                } else {
                    state.boosts[boostKey.replace("_", "")].push(timestamp);
                }
                applyBoosts();
                saveData();
                saveLocalStorage();
                updateUI();
                renderBoosts();
                console.log([${new Date().toISOString()}] Boost purchased:, { boostKey, nextLevel });
            } else {
                showError("Not enough coins!");
            }
        }

        // Приглашение друга
        function inviteFriend() {
            console.log([${new Date().toISOString()}] Generating invite link for userId: ${state.userId});
            const inviteLink = https://t.me/your_bot?start=${state.userId};
            const shareUrl = https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=Join%20my%20game!;
            console.log([${new Date().toISOString()}] Opening share URL: ${shareUrl});
            tg.openTelegramLink(shareUrl);
        }

        // Переключение вкладок
        function showTab(tabIndex) {
            console.log([${new Date().toISOString()}] Switching to tab: ${tabIndex});
            document.querySelectorAll(".content").forEach((content, index) => {
                content.style.display = index === tabIndex - 1 ? "block" : "none";
            });
            document.querySelectorAll(".tab").forEach((tab, index) => {
                tab.classList.toggle("active", index === tabIndex - 1);
            });
        }

        // Обработчики событий
        document.querySelectorAll(".tab").forEach(tab => {
            tab.addEventListener("click", () => {
                const tabIndex = parseInt(tab.getAttribute("data-tab"));
                console.log([${new Date().toISOString()}] Tab clicked: ${tabIndex});
                showTab(tabIndex);
            });
        });

        document.querySelector(".invite-friend").addEventListener("click", inviteFriend);

        // Запуск приложения
        console.log([${new Date().toISOString()}] Starting application...);
        startApp();
    </script>
</body>
</html>
